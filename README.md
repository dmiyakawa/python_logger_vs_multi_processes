# これは何

1つのプログラムを複数のプロセスで動作させ、
同じファイルを対象にRotatingFileHandlerでローテーションを行った際に
何が起こるかを実験するためのプログラム。

# 説明

単一プログラム内のマルチスレッドでの対応については公式ドキュメントに
記載があるのでここでは議論しない。
https://docs.python.jp/3/howto/logging-cookbook.html

上記の説明からも容易に予想できることではあるが、単純に
「ソースコードレベルではローテーションも書込みも何らロックされない」
ので、同じファイルを対象にログを書きあって同じタイミングでローテーションを
複数のプロセスが行おうとすると、ローテーション時に一部のログが消失する。

以下に例を示す

```
$ python multi_run.py -n 100 -t size
2017-06-14 14:14:40,669    INFO Start Running (Python 3.6.1)
2017-06-14 14:14:40,669    INFO Removing 3 logs
2017-06-14 14:14:40,670    INFO Using command "python do_log.py -t size -n 100"
2017-06-14 14:14:40,670    INFO Start running 5 processes
2017-06-14 14:14:40,688    INFO Waiting for 5 processes
2017-06-14 14:14:42,000 WARNING stderr for process 20280:
2017-06-14 14:14:42,001 WARNING >> --- Logging error ---
2017-06-14 14:14:42,001 WARNING >> Traceback (most recent call last):
2017-06-14 14:14:42,001 WARNING >>   File "/Users/dmiyakawa/.pyenv/versions/3.6.1/lib/python3.6/logging/handlers.py", line 72, in emit
2017-06-14 14:14:42,001 WARNING >>     self.doRollover()
2017-06-14 14:14:42,001 WARNING >>   File "/Users/dmiyakawa/.pyenv/versions/3.6.1/lib/python3.6/logging/handlers.py", line 173, in doRollover
2017-06-14 14:14:42,001 WARNING >>     self.rotate(self.baseFilename, dfn)
2017-06-14 14:14:42,001 WARNING >>   File "/Users/dmiyakawa/.pyenv/versions/3.6.1/lib/python3.6/logging/handlers.py", line 113, in rotate
2017-06-14 14:14:42,001 WARNING >>     os.rename(source, dest)
2017-06-14 14:14:42,001 WARNING >> FileNotFoundError: [Errno 2] No such file or directory: '/Users/dmiyakawa/src/python_logger_vs_multi_processes/result.log' -> '/Users/dmiyakawa/src/python_logger_vs_multi_processes/result.log.1'
2017-06-14 14:14:42,001 WARNING >> Call stack:
2017-06-14 14:14:42,001 WARNING >>   File "do_log.py", line 74, in <module>
2017-06-14 14:14:42,001 WARNING >>     sys.exit(main())
2017-06-14 14:14:42,001 WARNING >>   File "do_log.py", line 68, in main
2017-06-14 14:14:42,001 WARNING >>     do_log(args, logger)
2017-06-14 14:14:42,001 WARNING >>   File "do_log.py", line 17, in do_log
2017-06-14 14:14:42,001 WARNING >>     logger.info('{}'.format(i))
2017-06-14 14:14:42,001 WARNING >> Message: '50'
2017-06-14 14:14:42,001 WARNING >> Arguments: ()
2017-06-14 14:14:42,001 WARNING >>
2017-06-14 14:14:42,001 WARNING stderr for process 20281:
2017-06-14 14:14:42,001 WARNING >> --- Logging error ---
2017-06-14 14:14:42,001 WARNING >> Traceback (most recent call last):
2017-06-14 14:14:42,002 WARNING >>   File "/Users/dmiyakawa/.pyenv/versions/3.6.1/lib/python3.6/logging/handlers.py", line 72, in emit
2017-06-14 14:14:42,002 WARNING >>     self.doRollover()
2017-06-14 14:14:42,002 WARNING >>   File "/Users/dmiyakawa/.pyenv/versions/3.6.1/lib/python3.6/logging/handlers.py", line 173, in doRollover
2017-06-14 14:14:42,002 WARNING >>     self.rotate(self.baseFilename, dfn)
2017-06-14 14:14:42,002 WARNING >>   File "/Users/dmiyakawa/.pyenv/versions/3.6.1/lib/python3.6/logging/handlers.py", line 113, in rotate
2017-06-14 14:14:42,002 WARNING >>     os.rename(source, dest)
2017-06-14 14:14:42,002 WARNING >> FileNotFoundError: [Errno 2] No such file or directory: '/Users/dmiyakawa/src/python_logger_vs_multi_processes/result.log' -> '/Users/dmiyakawa/src/python_logger_vs_multi_processes/result.log.1'
2017-06-14 14:14:42,002 WARNING >> Call stack:
2017-06-14 14:14:42,002 WARNING >>   File "do_log.py", line 74, in <module>
2017-06-14 14:14:42,002 WARNING >>     sys.exit(main())
2017-06-14 14:14:42,002 WARNING >>   File "do_log.py", line 68, in main
2017-06-14 14:14:42,002 WARNING >>     do_log(args, logger)
2017-06-14 14:14:42,002 WARNING >>   File "do_log.py", line 17, in do_log
2017-06-14 14:14:42,002 WARNING >>     logger.info('{}'.format(i))
2017-06-14 14:14:42,002 WARNING >> Message: '50'
2017-06-14 14:14:42,002 WARNING >> Arguments: ()
2017-06-14 14:14:42,002 WARNING >>
2017-06-14 14:14:42,010    INFO Confirming (pids: [20279, 20280, 20281, 20282, 20283])
2017-06-14 14:14:42,015 WARNING 2/500 entries are missing ((20280, 50),(20281, 50))
2017-06-14 14:14:42,015    INFO Finished Running
```

「被害規模」はそのときに失われたログファイルによる。
上のケースは比較的運が良い。

TimedRotatingFileHandler を用いている場合はもう少し悲惨で、
ローテーションが発生するタイミングが概ねいつも一致するため、
より露骨にこの問題が発生する。以下に例を示す


```
$ python multi_run.py -n 100 -t time
2017-06-14 14:15:59,127    INFO Start Running (Python 3.6.1)
2017-06-14 14:15:59,128    INFO Removing 4 logs
2017-06-14 14:15:59,129    INFO Using command "python do_log.py -t time -n 100"
2017-06-14 14:15:59,129    INFO Start running 5 processes
2017-06-14 14:15:59,165    INFO Waiting for 5 processes
2017-06-14 14:16:00,512 WARNING stderr for process 20313:
2017-06-14 14:16:00,512 WARNING >> --- Logging error ---
2017-06-14 14:16:00,512 WARNING >> Traceback (most recent call last):
2017-06-14 14:16:00,512 WARNING >>   File "/Users/dmiyakawa/.pyenv/versions/3.6.1/lib/python3.6/logging/handlers.py", line 72, in emit
2017-06-14 14:16:00,512 WARNING >>     self.doRollover()
2017-06-14 14:16:00,512 WARNING >>   File "/Users/dmiyakawa/.pyenv/versions/3.6.1/lib/python3.6/logging/handlers.py", line 396, in doRollover
2017-06-14 14:16:00,512 WARNING >>     self.rotate(self.baseFilename, dfn)
2017-06-14 14:16:00,512 WARNING >>   File "/Users/dmiyakawa/.pyenv/versions/3.6.1/lib/python3.6/logging/handlers.py", line 113, in rotate
2017-06-14 14:16:00,512 WARNING >>     os.rename(source, dest)
2017-06-14 14:16:00,512 WARNING >> FileNotFoundError: [Errno 2] No such file or directory: '/Users/dmiyakawa/src/python_logger_vs_multi_processes/result.log' -> '/Users/dmiyakawa/src/python_logger_vs_multi_processes/result.log.2017-06-14_14-15-59'
2017-06-14 14:16:00,512 WARNING >> Call stack:
2017-06-14 14:16:00,512 WARNING >>   File "do_log.py", line 74, in <module>
2017-06-14 14:16:00,512 WARNING >>     sys.exit(main())
2017-06-14 14:16:00,512 WARNING >>   File "do_log.py", line 68, in main
2017-06-14 14:16:00,512 WARNING >>     do_log(args, logger)
2017-06-14 14:16:00,512 WARNING >>   File "do_log.py", line 17, in do_log
2017-06-14 14:16:00,512 WARNING >>     logger.info('{}'.format(i))
2017-06-14 14:16:00,512 WARNING >> Message: '57'
2017-06-14 14:16:00,512 WARNING >> Arguments: ()
2017-06-14 14:16:00,512 WARNING >>
2017-06-14 14:16:00,513    INFO Confirming (pids: [20309, 20310, 20311, 20312, 20313])
2017-06-14 14:16:00,515 WARNING 416/500 entries are missing ((20309, 0),(20309, 1),(20309, 2),(20309, 3),(20309, 4),(20309, 5),(20309, 6),(20309, 7),(20309, 8),(20309, 9),(20309, 10),(20309, 11),(20309, 12),(20309, 13),(20309, 14),(20309, 15),(20309, 16),(20309, 17),(20309, 18),(20309, 19),(20309, 20),(20309, 21),(20309, 22),(20309, 23),(20309, 24),(20309, 25),(20309, 26),(20309, 27),(20309, 28),(20309, 29),(20309, 30),(20309, 31),(20309, 32),(20309, 33),(20309, 34),(20309, 35),(20309, 36),(20309, 37),(20309, 38),(20309, 39),(20309, 40),(20309, 41),(20309, 42),(20309, 43),(20309, 44),(20309, 45),(20309, 46),(20309, 47),(20309, 48),(20309, 49),(20309, 50),(20309, 51),(20309, 52),(20309, 53),(20309, 54),(20309, 55),(20309, 56),(20309, 57),(20309, 58),(20309, 59),(20309, 60),(20309, 61),(20309, 62),(20309, 63),(20309, 64),(20309, 65),(20309, 66),(20309, 67),(20309, 68),(20309, 69),(20309, 70),(20309, 71),(20309, 72),(20309, 73),(20309, 74),(20309, 75),(20309, 76),(20309, 77),(20309, 78),(20309, 79),(20309, 80),(20309, 81),(20309, 82),(20309, 83),(20309, 84),(20309, 85),(20309, 86),(20309, 87),(20309, 88),(20309, 89),(20309, 90),(20309, 91),(20309, 92),(20309, 93),(20309, 94),(20309, 95),(20309, 96),(20309, 97),(20309, 98),(20309, 99),(20310, 0),(20310, 1),(20310, 2),(20310, 3),(20310, 4),(20310, 5),(20310, 6),(20310, 7),(20310, 8),(20310, 9),(20310, 10),(20310, 11),(20310, 12),(20310, 13),(20310, 14),(20310, 15),(20310, 16),(20310, 17),(20310, 18),(20310, 19),(20310, 20),(20310, 21),(20310, 22),(20310, 23),(20310, 24),(20310, 25),(20310, 26),(20310, 27),(20310, 28),(20310, 29),(20310, 30),(20310, 31),(20310, 32),(20310, 33),(20310, 34),(20310, 35),(20310, 36),(20310, 37),(20310, 38),(20310, 39),(20310, 40),(20310, 41),(20310, 42),(20310, 43),(20310, 44),(20310, 45),(20310, 46),(20310, 47),(20310, 48),(20310, 49),(20310, 50),(20310, 51),(20310, 52),(20310, 53),(20310, 54),(20310, 55),(20310, 56),(20310, 57),(20311, 0),(20311, 1),(20311, 2),(20311, 3),(20311, 4),(20311, 5),(20311, 6),(20311, 7),(20311, 8),(20311, 9),(20311, 10),(20311, 11),(20311, 12),(20311, 13),(20311, 14),(20311, 15),(20311, 16),(20311, 17),(20311, 18),(20311, 19),(20311, 20),(20311, 21),(20311, 22),(20311, 23),(20311, 24),(20311, 25),(20311, 26),(20311, 27),(20311, 28),(20311, 29),(20311, 30),(20311, 31),(20311, 32),(20311, 33),(20311, 34),(20311, 35),(20311, 36),(20311, 37),(20311, 38),(20311, 39),(20311, 40),(20311, 41),(20311, 42),(20311, 43),(20311, 44),(20311, 45),(20311, 46),(20311, 47),(20311, 48),(20311, 49),(20311, 50),(20311, 51),(20311, 52),(20311, 53),(20311, 54),(20311, 55),(20311, 56),(20311, 57),(20311, 58),(20311, 59),(20311, 60),(20311, 61),(20311, 62),(20311, 63),(20311, 64),(20311, 65),(20311, 66),(20311, 67),(20311, 68),(20311, 69),(20311, 70),(20311, 71),(20311, 72),(20311, 73),(20311, 74),(20311, 75),(20311, 76),(20311, 77),(20311, 78),(20311, 79),(20311, 80),(20311, 81),(20311, 82),(20311, 83),(20311, 84),(20311, 85),(20311, 86),(20311, 87),(20311, 88),(20311, 89),(20311, 90),(20311, 91),(20311, 92),(20311, 93),(20311, 94),(20311, 95),(20311, 96),(20311, 97),(20311, 98),(20311, 99),(20312, 0),(20312, 1),(20312, 2),(20312, 3),(20312, 4),(20312, 5),(20312, 6),(20312, 7),(20312, 8),(20312, 9),(20312, 10),(20312, 11),(20312, 12),(20312, 13),(20312, 14),(20312, 15),(20312, 16),(20312, 17),(20312, 18),(20312, 19),(20312, 20),(20312, 21),(20312, 22),(20312, 23),(20312, 24),(20312, 25),(20312, 26),(20312, 27),(20312, 28),(20312, 29),(20312, 30),(20312, 31),(20312, 32),(20312, 33),(20312, 34),(20312, 35),(20312, 36),(20312, 37),(20312, 38),(20312, 39),(20312, 40),(20312, 41),(20312, 42),(20312, 43),(20312, 44),(20312, 45),(20312, 46),(20312, 47),(20312, 48),(20312, 49),(20312, 50),(20312, 51),(20312, 52),(20312, 53),(20312, 54),(20312, 55),(20312, 56),(20312, 57),(20312, 58),(20312, 59),(20312, 60),(20312, 61),(20312, 62),(20312, 63),(20312, 64),(20312, 65),(20312, 66),(20312, 67),(20312, 68),(20312, 69),(20312, 70),(20312, 71),(20312, 72),(20312, 73),(20312, 74),(20312, 75),(20312, 76),(20312, 77),(20312, 78),(20312, 79),(20312, 80),(20312, 81),(20312, 82),(20312, 83),(20312, 84),(20312, 85),(20312, 86),(20312, 87),(20312, 88),(20312, 89),(20312, 90),(20312, 91),(20312, 92),(20312, 93),(20312, 94),(20312, 95),(20312, 96),(20312, 97),(20312, 98),(20312, 99),(20313, 0),(20313, 1),(20313, 2),(20313, 3),(20313, 4),(20313, 5),(20313, 6),(20313, 7),(20313, 8),(20313, 9),(20313, 10),(20313, 11),(20313, 12),(20313, 13),(20313, 14),(20313, 15),(20313, 16),(20313, 17),(20313, 18),(20313, 19),(20313, 20),(20313, 21),(20313, 22),(20313, 23),(20313, 24),(20313, 25),(20313, 26),(20313, 27),(20313, 28),(20313, 29),(20313, 30),(20313, 31),(20313, 32),(20313, 33),(20313, 34),(20313, 35),(20313, 36),(20313, 37),(20313, 38),(20313, 39),(20313, 40),(20313, 41),(20313, 42),(20313, 43),(20313, 44),(20313, 45),(20313, 46),(20313, 47),(20313, 48),(20313, 49),(20313, 50),(20313, 51),(20313, 52),(20313, 53),(20313, 54),(20313, 55),(20313, 56),(20313, 57))
2017-06-14 14:16:00,516    INFO Finished Running
```

見ての通り、ほとんどログが失われた。

ローテーションがない場合には、Python (3.6.0) では
Streamへのflushがログレコード単位で毎回発生する。
そのため、LogRecordがOSのバッファより十分小さければ
(つまり一つ一つのログが今回のように小さければ)
「行が混ざる」リスクはかなり低い(ほぼない)と予想できる。
以下に例を示す。

```
$ python multi_run.py -p 20 -n 10000 -t file
2017-06-14 14:17:05,425    INFO Start Running (Python 3.6.1)
2017-06-14 14:17:05,426    INFO Removing 2 logs
2017-06-14 14:17:05,426    INFO Using command "python do_log.py -t file -n 10000"
2017-06-14 14:17:05,426    INFO Start running 20 processes
2017-06-14 14:17:05,592    INFO Waiting for 20 processes
2017-06-14 14:19:00,527    INFO Confirming (pids: [20338, 20339, 20340, 20341, 20342, 20343, 20344, 20345, 20346, 20347, 20348, 20349, 20350, 20351, 20352, 20353, 20354, 20355, 20356, 20357])
2017-06-14 14:19:01,508    INFO Finished Running
```

ただし当然のことながら「保証されている」わけではない。

ローテーションについて、以上の問題を回避する呼び出し側の対策というのは
一般的にはないように思われる。一応の可能性として、独自のロックを介した
FileHandlerを自前で作成することは想像できるが、Logger.emit()が
著しく遅くなることから別の問題が発生するだろう。
ロガーに対して行うことのようにはとても思われない。

単に別途ログメッセージを受け取るサーバ・デーモンを別途準備しておき、
その単一プロセスにログ集約を任せるのが一般的だろう。
実際マルチスレッドでの事例はスレッドレベルでそれを行っているに過ぎない。
標準Pythonの範囲であればSysLogHandler、より大規模な集約を想定して
Fluentd等々色々選択肢はある。

参考: http://d.hatena.ne.jp/higher_tomorrow/20101225/1293277510

# License

MIT

Trust me, you won't be sued :-)
And, don't sue me for this kind of tiny junk-ish program :-(
